name: Notion Database Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Notion Data
        run: |
          curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{}' > cd_backup.json

      - name: Convert JSON to Markdown Table
        run: |
          python - <<EOF
          import json
          try:
              with open('cd_backup.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write('# ðŸ’¿ è³¼å…¥æ¸ˆã¿CDãƒªã‚¹ãƒˆ\n\n')
                  f.write('| ã‚¿ã‚¤ãƒˆãƒ« | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ | ç™ºå£²æ—¥ |\n')
                  f.write('| :--- | :--- | :--- |\n')
                  
                  results = data.get('results', [])
                  if not results:
                      f.write('| Notionã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒå±Šã„ã¦ã„ã¾ã›ã‚“ | æŽ¥ç¶šè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ | |\n')
                  
                  for row in results:
                      props = row.get('properties', {})
                      
                      # 1. ã‚¿ã‚¤ãƒˆãƒ«åˆ—ï¼ˆåå‰ã«é–¢ã‚ã‚‰ãš'title'ã‚¿ã‚¤ãƒ—ã‚’æŽ¢ã™ï¼‰
                      title = "ä¸æ˜Ž"
                      for p in props.values():
                          if p.get('type') == 'title':
                              t_list = p.get('title', [])
                              if t_list: title = t_list[0].get('plain_text', 'ä¸æ˜Ž')
                              break

                      # 2. ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ—ï¼ˆåå‰ã§æŒ‡å®šï¼‰
                      a_prop = props.get('ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ', {}).get('rich_text', [])
                      artist = a_prop[0].get('plain_text', '-') if a_prop else '-'
                      
                      # 3. ç™ºå£²æ—¥åˆ—ï¼ˆåå‰ã§æŒ‡å®šï¼‰
                      d_prop = props.get('ç™ºå£²æ—¥', {}).get('date')
                      date_val = d_prop.get('start', '-') if d_prop and d_prop.get('start') else '-'
                      
                      f.write(f'| {title} | {artist} | {date_val} |\n')
          except Exception as e:
              f.write(f'| ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)} | | |\n')
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cd_backup.json README.md
          git commit -m "chore: update backup and list [$(date +'%Y-%m-%d %H:%M:%S')]" || exit 0
          git push
