name: Notion Database Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Notion Data
        run: |
          curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{}' > cd_backup.json

      - name: Convert JSON to Markdown Table
        run: |
          python - <<EOF
          import json
          try:
              with open('cd_backup.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write('# ðŸ’¿ è³¼å…¥æ¸ˆã¿CDãƒªã‚¹ãƒˆ\n\n')
                  f.write('| ã‚¿ã‚¤ãƒˆãƒ« | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ | ç™ºå£²æ—¥ |\n')
                  f.write('| :--- | :--- | :--- |\n')
                  
                  for row in data.get('results', []):
                      props = row.get('properties', {})
                      
                      # å„åˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                      title_list = props.get('ã‚¿ã‚¤ãƒˆãƒ«', {}).get('title', [])
                      title = title_list[0].get('plain_text', 'ä¸æ˜Ž') if title_list else 'ä¸æ˜Ž'
                      
                      artist_list = props.get('ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ', {}).get('rich_text', [])
                      artist = artist_list[0].get('plain_text', '-') if artist_list else '-'
                      
                      date = props.get('ç™ºå£²æ—¥', {}).get('date', {})
                      date_val = date.get('start', '-') if date else '-'
                      
                      f.write(f'| {title} | {artist} | {date_val} |\n')
          except Exception as e:
              print(f"Error: {e}")
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cd_backup.json README.md
          git commit -m "chore: update backup and list [$(date +'%Y-%m-%d %H:%M:%S')]" || exit 0
          git push
