name: Notion Database Backup

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Notion Data
        run: |
          curl -X POST "https://api.notion.com/v1/databases/${{ secrets.NOTION_DATABASE_ID }}/query" \
            -H "Authorization: Bearer ${{ secrets.NOTION_TOKEN }}" \
            -H "Notion-Version: 2022-06-28" \
            -H "Content-Type: application/json" \
            --data '{}' > cd_backup.json

      - name: Convert JSON to Markdown Table
        run: |
          python - <<EOF
          import json
          with open('cd_backup.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write('# ðŸ’¿ è³¼å…¥æ¸ˆã¿CDãƒªã‚¹ãƒˆ\n\n')
              f.write('| ã‚¿ã‚¤ãƒˆãƒ« | ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ | è³¼å…¥æ—¥ |\n')
              f.write('| :--- | :--- | :--- |\n')
              
              for row in data.get('results', []):
                  props = row.get('properties', {})
                  # ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£åã¯Notionã®å®Ÿéš›ã®åˆ—åã«åˆã‚ã›ã¦èª¿æ•´ãŒå¿…è¦ã§ã™
                  title = props.get('ã‚¿ã‚¤ãƒˆãƒ«', {}).get('title', [{}])[0].get('plain_text', 'ä¸æ˜Ž')
                  artist = props.get('ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ', {}).get('rich_text', [{}])[0].get('plain_text', '-')
                  date = props.get('è³¼å…¥æ—¥', {}).get('date', {}).get('start', '-')
                  f.write(f'| {title} | {artist} | {date} |\n')
          EOF

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add cd_backup.json README.md
          git commit -m "chore: update backup and list [$(date +'%Y-%m-%d %H:%M:%S')]" || exit 0
          git push
